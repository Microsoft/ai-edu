# 11.2 第二步：从用例图到数据流图

本节依然属于需求分析的范畴，紧接着 11.1 节的内容。

## 11.2.1 参与者独立数据流图

我们根据 11.1 中的需求描述，把每个参与者（客户、研究员、工程师）的数据流图单独画出来，这样可以避免一开始就陷入复杂的逻辑纠缠中。见图 11.2.1。

<div align="center">
<img src="Images/Slide6.JPG"/>

图 11.2.1 - 独立数据流图
</div>

图 11.2.1 中的各个图例没有按照标准的数据流图图例（见6.8节）绘制，而是使用了更生动的彩色图例。其中：

- 人形图标代表参与者；
- 椭圆形图例代表加工逻辑；
- 侧偏形图例代表存储；
- 有方向的线代表数据流。

### 客户数据流图

1. 用户上传数据到云端的数据存储上；
2. 用户得到通知后，下载预测结果文件。

对用户来说比较简单，就是两个动作：上传、下载，后面的一切流程都是透明的。所以，我们需要设计“上传”和“下载”的实现。

### 研究员数据流图

1. 研究员在自己的计算机上设计模型，并提交训练代码到云端存储；
2. 云端有一个代码存储库（蓝色存储），包括模型、代码、初始参数等；
3. 研究员登录到云端服务器，启动模型训练过程；
4. 在训练开始时，需要读取存储在云端的股票历史数据（浅绿色存储）并进行预处理；
5. 训练结束后，把成熟的模型存放到模型库（深蓝色存储），供后续流程使用。
6. 对模型库进行管理，比如删除一些性能较差的模型。

对研究员来说，“提交训练代码”和“模型训练”是两个主要动作，代码可以在本地计算机上完成实现，与 Azure 交互的是“提交”动作，还要考虑“训练”部署在什么设备上运行，其它的一些辅助存储需要 Azure 上的哪种存储设备。

### 工程师数据流图

1. 开发完毕后，提交预测代码到云端部署（蓝色存储）；
2. 启动模型预测过程；
3. 在预测开始前，要读取股票历史数据和最新上传的数据（浅绿色存储）并进行预处理，还要从模型库（深蓝色存储）中读取最新模型；
4. 预测完毕后，输出结果文件（绿色存储）。

对于工程师来说，“提交预测代码”和“预测”是两个主要动作，代码可以在本地计算机上完成实现，与 Azure 交互的是“提交”动作，还要考虑“预测”部署在什么设备上运行，其它的一些辅助存储需要 Azure 上的哪种存储设备。

## 11.2.2 整体数据流图

下面我们需要把三个独立的数据流图合并成一个完整的数据流图，来发现需要改进的地方。如图 11.2.2 所示。

<div align="center">
<img src="Images/Slide7.JPG"/>

图 11.2.2 - 整体数据流图
</div>

合并的过程很简单，把图 11.2.1 中重复（具有相同名字并且相同颜色）的单元删掉，但是保留连接线。比如“数据存储”单元一共有三个，删掉右侧的两个，然后把“上传文件”连接到左侧的“数据存储”上，再把“模型预测”连接到左侧的“数据存储”上，箭头方向保持不变。

如此重复，去掉所有重名重色的单元后，再调整各个单元的位置，尽量让连接线没有交叉，就变成了图 11.2.2 的样子。当然，由于这是一个拓扑图，所以可能画法不止一种。另外，由于“模型管理”是一个独立的动作，不影响整体数据流的运转，所以没有画在图 11.2.2 中。

被合并的存储图例有：
- 数据存储
- 代码存储
- 模型库
- 结果文件

被合并的加工逻辑有：
- 数据处理

熟悉 AI 模型训练和预测过程的读者都知道，数据处理在训练和预测时必须保持一致，否则或造成预测结果与模型不匹配。比如：
- 训练过程要求输入三个特征值，那么数据处理就会把数据提取出三个特征值来，在预测时需要同样的三个特征值，而不是两个或者四个；
- 训练过程要求其中一个特征值的值域范围为 $[0,1]$，那么预测前也必须把该特征值做相同的归一化处理。

所以，数据处理模块实际上训练和预测共用的，必须合并为一个。

与图 11.2.1 不同的是，这里多了一个深色的矩形区域“Azure”，表明在我们的设计中，矩形区域内的元素，包括数据、行为、流程，都应该使用 Azure 提供的技术。

## 11.2.3 数据流图的潜规则

得到图 11.2.2 后，就可以进行下一步的设计工作了。注意，在依赖数据流图把需求分析变成系统设计的过程中，有一些“潜规则”：

<div align="center">
<img src="Images/Slide8.JPG"/>
图 11.2.3 - 数据流图的“潜规则”
</div>

1. “参与者”到“加工逻辑”之间的连线（有方向），表示有交互式用户界面，或者可执行程序（也可以看作是界面的一种）。有的教程中用鲁棒图来表示。
   
2. 两个“加工逻辑” A 与 B 之间的连线，表示 A 调用/通知 B，也可能需要设计出来一个主控程序，按顺序调用二者，但是主控程序并不在数据流图内（因为数据流图属于需求分析范畴，而主控程序属于设计范畴）。如图 11.2.3 中的黄色椭圆所示。
   
3. “加工逻辑”到“数据存储”的连线（有方向），表示调用“写入”功能。
   
4. “数据存储”到“加工逻辑”的连线（有方向），表示调用“读出”功能，但是此时的“加工逻辑”不能凭空运行，需要有调用者，见2。
