# 11.5 行为设计

## 11.5.1 控制中心的技术选择

首先要确定软件开发环境。因为训练、预测、模型管理都使用了 Python，所以我们干脆也用 Python 来实现控制门户吧，代码管理方便，部署环境一致，技术栈统一。

在 Python 中有很多 RESTful Web 框架，如 Django REST framework，Flask-RESTful 等等。

- Django REST framework 是一个功能强大且灵活的 REST Web API 框架，包含 OAuth1a、OAuth2身份验证策略，支持 ORM 和非 ORM 数据源的序列化，使用基于函数的常规视图实现自定义你所需要的功能，有广泛的文档资料和社区支持。

- Tornado是一种 Web 服务器软件的开源版本。Tornado 和现在的主流 Web 服务器框架（包括大多数 Python 的框架）有着明显的区别：它是非阻塞式服务器，而且速度相当快。得利于其非阻塞的方式和对epoll的运用，Tornado 每秒可以处理数以千计的连接，因此 Tornado 是实时 Web 服务的一个理想框架。

- Flask 是一个使用 Python 编写的轻量级 Web 应用框架。其 WSGI 工具箱采用 Werkzeug ，模板引擎则使用 Jinja2 。Flask也被称为 “microframework” ，因为它使用简单的核心，用 extension 增加其他功能。Flask没有默认使用的数据库、窗体验证工具。Flask 很轻，花很少的成本就能够开发一个简单的网站。非常适合初学者学习。Flask 框架学会以后，可以考虑学习插件的使用。例如使用 WTForm + Flask-WTForm 来验证表单数据，用 SQLAlchemy + Flask-SQLAlchemy 来对你的数据库进行控制。

还有4、5个其它的框架，都有很多拥趸。对于我们这个系统，用户很少，所以对性能没什么要求，只要开发简单、能够稳定运行即可。所以最后木头选择了 Flask API，只用十几行代码就可以搞定框架部分，每个 API 定义一个函数，指定好传入的参数，非常的方便，调试也很简单。

## 11.5.2 控制中心的状态转换

在数据流图中定义了一些列的流程，但是并没有给出所有的分支和细节，所以我们在这一小节要通过对控制中心的状态转换设计来捋清楚所有细节。绘制传统的流程图也是可以做到这一点的，但是不包含状态名称信息，在后面的文档或者开发过程中，不容易形成共同语言。

<div align="center">
<img src="Images/Slide13.JPG"/>

图 11.5.1 - 控制中心状态设计
</div>

||->已启动|->已上传|->训练中|->已训练|->预测中|->已预测|->已发布|->终止|
|--|--|--|--|--|--|--|--|--|
|起始->|启动门户|||
|已启动->||上传数据|
|已上传->|||检查数据(合格)启动训练|||||检查数据(不合格)终止|
|训练中->||||训练完毕|
|已训练->|||||训练结果-启动预测|
|预测中->||||||预测完毕|
|已预测->|||||||检查结果(合格)发布结果|检查结果(不合格)终止|
|已发布->||||||||发布完毕|


## 11.5.3 虚拟机状态设计

由于系统都运行在 Azure 上，而且定制化程度较高，所以我们都使用 Azure 上的虚拟机来搭建控制中心、训练子系统、预测子系统。

由于虚拟机的收费较高，所以要研究清楚虚拟机的收费策略，即：
- 虚拟机在打开时，是按时长收费的，不管是否运行了应用程序；
- 虚拟机在关闭后，仍然收费；
- 虚拟机在释放后，停止收费，但是这是一种假的释放，里面按照的应用和数据还是可以再打开虚拟机后继续使用的，不会丢失；
- 虚拟机在删除后，数据全部丢失。

把上面的策略总结成状态转换，如图 11.5.2 所示。

<div align="center">
<img src="Images/Slide14.JPG"/>

图 11.5.2 - 虚拟机状态设计
</div>
