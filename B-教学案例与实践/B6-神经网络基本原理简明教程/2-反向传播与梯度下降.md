Copyright © Microsoft Corporation. All rights reserved.
  适用于[License](https://github.com/Microsoft/ai-edu/blob/master/LICENSE.md)版权许可

反向传播和梯度下降这两个词，第一眼看上去似懂非懂，不明觉厉。这两个概念是整个神经网络中的重要组成部分，是和误差函数/损失函数的概念分不开的。

神经网络训练的最基本的思想就是：先“蒙”一个结果，我们叫预测结果a，看看这个预测结果和事先标记好的训练集中的真实结果y之间的差距，然后调整策略，再试一次，这一次就不是“蒙”了，而是有依据地向正确的方向靠近。如此反复多次，一直到预测结果和真实结果之间相差无几，亦即|a-y|->0，就结束训练。

在神经网络训练中，我们把“蒙”叫做初始化，可以随机，也可以根据以前的经验给定初始值。即使是“蒙”，也是有技术含量的。

# 通俗地理解反向传播

举个通俗的例子，Bob拿了一支步枪，射击100米外的靶子。这支步枪没有准星，或者是准星有bug，或者是Bob眼神儿不好看不清靶子，或者是雾很大，或者风很大，或者由于木星的影响而侧向引力场异常......反正就是Bob很倒霉。

第一次试枪后，拉回靶子一看，弹着点偏左了，于是在第二次试枪时，Bob就会有意识地向右侧偏几毫米，再看靶子上的弹着点，如此反复几次，Bob就会掌握这支步枪的脾气了。下图显示了Bob的5次试枪过程：

<img src=".\Images\2\target1.png" width="500">

在这个例子中：

- 每次试枪弹着点和靶心之间的差距就叫做误差，可以用一个误差函数来表示，比如差距的绝对值，如图中的红色线。
- 一共试枪5次，就是迭代/训练了5次的过程 。
- 每次试枪后，把靶子拉回来看弹着点，然后调整下一次的射击角度的过程，叫做反向传播。注意，把靶子拉回来看和跑到靶子前面去看有本质的区别，后者容易有生命危险，因为还有别的射击者。一个不恰当的比喻是，在数学概念中，人跑到靶子前面去看，叫做正向微分；把靶子拉回来看，叫做反向微分。
- 每次调整角度的数值和方向，叫做梯度。比如向右侧调整1毫米，或者向左下方调整2毫米。如图中的绿色矢量线。

上图是每次单发点射，所以每次训练样本的个数是1。在实际的神经网络训练中，通常需要多个样本，做批量训练，以避免单个样本本身采样时带来的误差。在本例中，多个样本可以描述为连发射击，假设一次可以连打3发子弹，每次的离散程度都类似，如下图所示：

<img src=".\Images\2\target2.png" width="500">

-  如果每次3发子弹连发，这3发子弹的弹着点和靶心之间的差距之和再除以3，叫做损失，可以用损失函数来表示。

其实射击还不这么简单，如果是远距离狙击，还要考虑空气阻力和风速，在神经网络里，空气阻力和风速可以对应到隐藏层的概念上。


# 通俗地理解损失函数

在各种材料中经常看到的中英文词汇有：误差，偏差，Error，Cost，Loss，损失，代价......意思都差不多，在本系列文章中，使用损失函数和Loss Function这两个词汇。

假设有一个黑盒子，这个样子：
<img src=".\Images\2\blackbox.png">

我们只能看到输入和输出的数值，看不到里面的样子，当输入1时，输出3.212，然后黑盒子有个大喇叭喊话：我需要输出值是4。然后我们试了试输入2，结果输出5.238，一下子比4大了很多。那么我们第一次的损失值是$3.212-4=-0.788$，而二次的损失值是$5.238-4=1.238$。这里，我们的损失函数就是一个简单的减法，用实际值减去目标值，但是它可以告诉你两个信息：1）方向，是大了还是小了；2）差值，是0.1还是1.1。这样就给了我们下一次猜的依据。

而上面这件事真正的意义并不是猜测当输入是多少时输出会是4。它的实际意义是：我们要破解这个黑盒子！于是，我们会有如下破解流程：
1. 记录下所有输入值和输出值：(1, 3.212), (1.1, 3.474), (1.2, 3.672), (2, 5.238),...其中，括号里前面的数叫输入值，后面的值叫标签值。可以列个表：

|输入|输出(标签)|
|--|--|
|1|3.212|
|1.1|3.474|
|1.2|3.672|
|2|5.238|

2. 搭建一个神经网络，给出初始权重值
3. 输入1，假设得到输出为2.3，而实际的输出值是3.212，则误差值为$2.3-3.212=-0.912$
4. 调整权重值，比如系数提高一些，再输入1.1，假设得到的输出为3.37，则误差值为$3.37-3.474=-0.104$
5. 调整权重值，再输入1.2......
6. 调整权重值，再输入2......
7. 依此类推，重复3，4，5，6过程，直到损失函数值小于一个指标，比如0.001，我们就可以认为网络训练完毕，黑盒子“破解”(实际是被复制)了

从上面的过程可以看出，如果误差值是正数，我们就把权重降低一些；如果误差值为负数，则升高权重。

**损失**就是所有样本的**误差**的总和，亦即：$$损失 = \sum_i(误差_i)$$所以有时候损失函数可以和误差函数混用概念。

在黑盒子的例子中，我们如果说“某个样本的损失”是不对的，只能说“某个样本的误差”，如果我们把神经网络的参数调整到完全满足一个样本的输出误差为0，通常会令其它样本的误差变得更大，这样作为误差之和的损失函数值，就会变得更大。所以，我们通常会在根据某个样本的误差调整权重后，计算一下整体样本的损失函数值，来判定网络是不是已经训练到了可接受的状态。

在上面的例子中，我们使用单个样本进行训练。在批量样本训练中，实际写code时，经常会出现的问题是，忘记用样本误差之和除以样本数量，结果得到了比实际误差大很多的数值，造成网络训练结果波动。

最初的损失函数的概念，应该是从经济学引用过来的。比如一套新的营销策略，消费者是不是真的买账，还要拿到市场上去检验。市场就是个黑盒子，我们只能从最后的收支情况来判别营销策略的好坏：如果你挣钱了，就是好的策略；如果你赔钱了，有损失了，就是不合适的策略，损失越大，说明策略背离实际情况越多。


# 通俗地理解梯度下降

必须先有损失函数的概念，然后才能理解梯度下降。常用的损失函数里，有一种损失函数的形式是均方差，亦即：

$$loss = \sum_{i}(a_i - y_i) ^ 2$$

其中$a_i,y_i$是某个样本的预测值与标签值。如果所有样本中，$a_i == y_i$，则loss值为0，这是最理想的情况。但我们并不奢望每个样本的预测值都与标签值吻合，只要整体的误差小于某个值，就已经拟合的很好了。神经网络解决的不是数学问题，而是解决实际的工程问题，我们得不到解析解，所以近似度很高就可以了。近似度很高的意思就是，loss逼近最小值，但如何做到逼近最小值呢？梯度的概念，这时候该闪亮登场了！

梯度，是个矢量。

上面的损失函数的二维图像如下图所示：
<img src=".\Images\2\grad1.png" width="600"> 
其中，横坐标是预测值，纵坐标是损失值。假设真实值为1，那么预测值越接近1，损失函数的值越小。

### 为什么说是“梯度下降”？

“梯度下降”，刚接触这个词时，我总是往“降低难度”或“降低维度”方面去理解，因为有个“下降”的动词在里面。而实际上，“下降”在这里面的含义是“与导数相反的方向”的意思。

我们假设上面这个图形的函数是$y = (x-1)^2+0.01$，则$y'_x = 2(x-1)$。

- 在点B上，这个函数的切线（绿色）是指向下方的（Y轴方向），所以是个负数：
假设$X_B$ = 0.1，则$y' = 2*(0.1-1) = -1.8$
亦即点B的梯度是个**负数**。此时我们要把预测值向**正的方向**移动，亦即**梯度的反方向**。
- 在F点上，切线（绿色）向上：
假设$X_F$ = 1.5, 则$y' = 2*(1.5-1) = 1$
是个**正数**，此时我们要把预测值向左侧**负的方向**移动，也是**梯度的反方向**。

所以总体上看，无论预测值在极值的左侧还是右侧，只要是沿着梯度的反方向移动，损失函数值都会向中间（坡底）靠拢。

另外一种理解方式如下图所示：
<img src=".\Images\2\gd.png">  
不同的参数组合形成的损失函数值，可以形成一个不规则椭圆，不规则椭圆的圆心位置，是损失值为0的位置，也是我们要逼近的目标。

这个椭圆，类似地图等高线来表示的一个洼地，中心位置比边缘位置要低，通过对损失函数的计算，对损失函数的求导，对网络参数的求导，会带领我们沿着等高线形成的梯子一步步下降，无限逼近中心点。


### 曲线和弦线的关系？

<img src=".\Images\2\grad2.png" width="600">  

1. 我们先知道了A点的切线的方向，亦即黄色的线，但是不知道长度
2. 我们有步长值η，以及梯度下降公式$X_1 = X_0 – η * dx$
3. 因为$y'_x的导数dx = 2(X-1), η = 0.1, X_0 = 0.2, 于是有X_1 = X_0–0.1*2(X_0-1) = 0.36$，这就等同于我们知道了切线的长度，亦即绿色的线的长度和方向都确定了
4. 然后我们可以画出红色的线（亦即弦线）

所以，弦线在这里面没啥用途，只是表示一个迭代跳跃的动作而已。实际的变化值已经由绿色的线定义好了。

# 总结

- 在正向预测完成后，损失函数为我们提供了计算损失的方法
- 梯度下降法是在损失函数曲线上向着损失最小的点靠近而指引了网络权重调整的方向
- 反向传播把损失值反向传给神经网络的每一层，让每一层都根据损失值反向调整权重，依然是梯度下降的概念
