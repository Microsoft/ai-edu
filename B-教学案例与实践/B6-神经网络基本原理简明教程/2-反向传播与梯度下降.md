Copyright © Microsoft Corporation. All rights reserved.
  适用于[License](https://github.com/Microsoft/ai-edu/blob/master/LICENSE.md)版权许可

反向传播和梯度下降这两个词，第一眼看上去似懂非懂，不明觉厉。这两个概念是整个神经网络中的重要组成部分，是和误差函数/损失函数的概念分不开的。

神经网络训练的最基本的思想就是：先“蒙”一个结果，我们叫预测结果a，看看这个预测结果和事先标记好的训练集中的真实结果y之间的差距，然后调整策略，再试一次，这一次就不是“蒙”了，而是有依据地向正确的方向靠近。如此反复多次，一直到预测结果和真实结果之间相差无几，亦即|a-y|->0，就结束训练。

在神经网络训练中，我们把“蒙”叫做初始化，可以随机，也可以根据以前的经验给定初始值。即使是“蒙”，也是有技术含量的。

# 通俗地理解反向传播

举个通俗的例子，Bob拿了一支步枪，射击100米外的靶子。这支步枪没有准星，或者是准星有bug，或者是Bob眼神儿不好看不清靶子，或者是雾很大，或者风很大，或者由于木星的影响而侧向引力场异常......反正就是Bob很倒霉。

第一次试枪后，拉回靶子一看，弹着点偏左了，于是在第二次试枪时，Bob就会有意识地向右侧偏几毫米，再看靶子上的弹着点，如此反复几次，Bob就会掌握这支步枪的脾气了。下图显示了Bob的5次试枪过程：

<img src=".\Images\2\target1.png" width="500">

在这个例子中：

- 每次试枪弹着点和靶心之间的差距就叫做误差，可以用一个误差函数来表示，比如差距的绝对值，如图中的红色线。
- 一共试枪5次，就是迭代/训练了5次的过程 。
- 每次试枪后，把靶子拉回来看弹着点，然后调整下一次的射击角度的过程，叫做反向传播。注意，把靶子拉回来看和跑到靶子前面去看有本质的区别，后者容易有生命危险，因为还有别的射击者。一个不恰当的比喻是，在数学概念中，人跑到靶子前面去看，叫做正向微分；把靶子拉回来看，叫做反向微分。
- 每次调整角度的数值和方向，叫做梯度。比如向右侧调整1毫米，或者向左下方调整2毫米。如图中的绿色矢量线。

上图是每次单发点射，所以每次训练样本的个数是1。在实际的神经网络训练中，通常需要多个样本，做批量训练，以避免单个样本本身采样时带来的误差。在本例中，多个样本可以描述为连发射击，假设一次可以连打3发子弹，每次的离散程度都类似，如下图所示：

<img src=".\Images\2\target2.png" width="500">

-  如果每次3发子弹连发，这3发子弹的弹着点和靶心之间的差距之和再除以3，叫做损失，可以用损失函数来表示。

其实射击还不这么简单，如果是远距离狙击，还要考虑空气阻力和风速，在神经网络里，空气阻力和风速可以对应到隐藏层的概念上。


# 通俗地理解损失函数

在各种材料中经常看到的中英文词汇有：误差，偏差，Error，Cost，Loss，损失，代价......意思都差不多，在本系列文章中，使用损失函数和Loss Function这两个词汇。

**其实损失就是所有样本的误差的总和，所以有时候损失函数可以和误差函数混用概念。**
在批量样本训练中，实际写code时，经常会出现的问题是，忘记用样本误差之和除以样本数量，结果得到了比实际误差大很多的数值，造成网络训练结果波动。

假设有一个黑盒子，这个样子：
<img src=".\Images\2\blackbox.png">

我们只能看到输入和输出的数值，看不到里面的样子，当输入1时，输出3.212，然后黑盒子有个大喇叭喊话：我需要输出值是4。然后我们试了试输入2，结果输出5.238，一下子比4大了很多。

那么我们第一次的损失值是3.212-4=-0.788，而二次的损失值是5.238-4=1.238。这里，我们的损失函数就是一个简单的减法，但是它可以告诉你两个信息：1）方向，是大了还是小了；2）差值，是0.1还是1.1。

上面的射击的例子中，损失函数要复杂些，1）需要知道差几环，2）需要知道弹着点在上下左右哪个方位上，有个角度问题。

损失函数的值，都是一一个标量的形式表示的。

# 通俗地理解梯度下降

最简单的例子，是猜数游戏，不管你用了什么算法，比如二分法，出题者总会告诉你说：你猜的数大了或者小了，TA不会直接告诉你那个数是什么，只告诉你一个方向。



很多资料中会用下面这个图来说明梯度下降，但是都没有说清楚以下几个问题：

1） 为啥用这个看上去像$y = x^2$族的函数来说明梯度下降？

2） 在最低点的左侧，梯度值是负数；在最低点的右侧，梯度值是正数。为什么说是“下降”？

3） 为什么1—>2，2—>3等等的连线不是这条曲线的切线呢，而好像是弦线？

<img src=".\Images\2\grad1.png" width="600"> 



## 为何用$y = x^2$函数？

这是因为有一种损失函数的形式就是均方差，亦即：

$$loss = \sum_{i}(a_i - y_i) ^ 2$$

其中a是本次迭代的预测结果，y是样本中的真实结果。我们的目的就是在这个函数上求最小值，使loss最小，这样样本值和预测值就会非常非常接近，以便于我们以后预测不在样本中的真实数据。

## 为什么说是“梯度下降”？

“梯度下降”，刚接触这个词时，我总是往“降低难度”或“降低维度”方面去理解，因为有个“下降”的动词在里面。而实际上，“下降”在这里面的含义是“与导数相反的方向”的意思。

我们假设上面这个图形的函数是$y = (x-1)^2+0.001$，则$y’_x = 2(x-1)$。

- 在点B上，这个函数的切线（绿色）是指向下方的（Y轴方向），所以是个负数：假设$X_B$ = 0.1, 则$y’ = 2*(0.1-1) = -1.8$。
- 在F点上，切线（绿色）向上：假设$X_F$ = 1.5, 则$y’ = 2*(1.5-1) = 1$，是个正数。

而在标准的权重更新公式里：

$$w = w – η*\Delta{w}$$
$$b = b – η*\Delta{b}$$

可以看到无论是w还是b，都是用上一次的权重值减去步长$\times$梯度。

- 当梯度(y')是**正数**时，即点F的位置，$x = x - η*1$，切线向上，**x值会变小**，权重值会从右侧向x=1靠近；
- 当梯度(y')是**负数**时，亦即点B的位置，切线向下，**x值会变大**：$x = x - η*(-1.8) = x + η*1.8$，最终运算结果变成了加法，与切线方向相反，权重值会从左侧向x=1靠近。

所以总体上看，无论x在极值的左侧还是右侧，都会向中间（坡底）靠拢，确实是“下降”了。

不知不觉中，我们已经接触到了第一个神经网络中的超参η，即步长值，这个值对于神经网络训练非常重要，决定了训练时间的长短。

## 曲线和弦线的关系？

<img src=".\Images\2\grad2.png" width="600">  

1. 我们先知道了A点的切线的方向，亦即黄色的线，但是不知道长度
2. 我们有步长值η，以及梯度下降公式$X_1 = X_0 – η * dx$
3. 因为$y'_x的导数dx = 2(X-1), η = 0.1, X_0 = 0.2, 于是有X_1 = X_0–0.1*2(X_0-1) = 0.36$，这就等同于我们知道了切线的长度，亦即绿色的线的长度和方向都确定了
4. 然后我们可以画出红色的线（亦即弦线）

所以，弦线在这里面没啥用途，只是表示一个迭代跳跃的动作而已。实际的变化值已经由绿色的线定义好了。

# 参考资料
http://colah.github.io/posts/2015-08-Backprop/
