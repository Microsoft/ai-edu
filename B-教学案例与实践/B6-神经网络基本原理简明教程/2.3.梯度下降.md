Copyright © Microsoft Corporation. All rights reserved.
  适用于[License](https://github.com/Microsoft/ai-edu/blob/master/LICENSE.md)版权许可

# 梯度下降的数学理解

必须先有损失函数的概念，然后才能理解梯度下降。常用的损失函数里，有一种损失函数的形式是均方差，亦即：

$$loss = \sum_{i}(a_i - y_i) ^ 2$$

其中$a_i,y_i$是某个样本的预测值与标签值。如果所有样本中，$a_i == y_i$，则loss值为0，这是最理想的情况。但我们并不奢望每个样本的预测值都与标签值吻合，只要整体的误差小于某个值，就已经拟合的很好了。神经网络解决的不是数学问题，而是解决实际的工程问题，我们得不到解析解，所以近似度很高就可以了。近似度很高的意思就是，loss逼近最小值，但如何做到逼近最小值呢？梯度的概念，这时候该闪亮登场了！

**梯度，是个矢量。**

上面的损失函数的二维图像如下图所示：
<img src=".\Images\2\grad1.png" width="600"> 
其中，横坐标是预测值，纵坐标是损失值。假设真实值为1，那么预测值越接近1，损失函数的值越小。

### 为什么说是“梯度下降”？

“梯度下降”，刚接触这个词时，我总是往“降低难度”或“降低维度”方面去理解，因为有个“下降”的动词在里面。而实际上，“下降”在这里面的含义是“与导数相反的方向”的意思。

我们假设上面这个图形的函数是$y = (x-1)^2+0.01$，则$y'_x = 2(x-1)$。

- 在点B上，这个函数的切线（绿色）是指向下方的（Y轴方向），所以是个负数：
假设$X_B$ = 0.1，则$y'_{0.1} = 2*(0.1-1) = -1.8$
亦即点B的梯度是个**负数**。此时我们要把预测值向**正的方向**移动，亦即**梯度的反方向**。
- 在F点上，切线（绿色）向上：
假设$X_F$ = 1.5, 则$y'_{1.5} = 2*(1.5-1) = 1$
是个**正数**，此时我们要把预测值向左侧**负的方向**移动，也是**梯度的反方向**。

所以总体上看，无论预测值在极值的左侧还是右侧，只要是沿着梯度的反方向移动，损失函数值都会向中间（坡底）靠拢。

另外一种理解方式如下图所示：
<img src=".\Images\2\gd.png">  
不同的参数组合形成的损失函数值，可以形成一个不规则椭圆，不规则椭圆的圆心位置，是损失值为0的位置，也是我们要逼近的目标。

这个椭圆，类似地图等高线来表示的一个洼地，中心位置比边缘位置要低，通过对损失函数的计算，对损失函数的求导，对网络参数的求导，会带领我们沿着等高线形成的梯子一步步下降，无限逼近中心点。


如何使用损失函数呢？具体步骤：
1. 用随机值初始化前向计算公式
2. 代入样本，计算输出的预测值
3. 用损失函数计算预测值和标签值（真实值）的误差
4. 将误差回传，修订前向计算公式
5. goto 2, 直到损失函数值达到一个满意的值就停止迭代

如下图所示：
<img src=".\Images\2\grad2.png" width="600">  

1. 我们先知道了A点的切线的方向，亦即黄色的线，但是不知道长度
2. 我们有步长值η，以及梯度下降公式$X_1 = X_0 – η * dx$
3. 因为$y'_x的导数dx = 2(X-1), η = 0.1, X_0 = 0.2, 于是有X_1 = X_0–0.1*2(X_0-1) = 0.36$，这就等同于我们知道了切线的长度，亦即绿色的线的长度和方向都确定了
4. 然后我们可以画出红色的线（亦即弦线）

所以，弦线在这里面没啥用途，只是表示一个迭代跳跃的动作而已。实际的变化值已经由绿色的线定义好了。

## 学习率η的选择

在code里，我们把学习率定义为learning_rate，或者eta，或者叫 $\alpha$
针对上面的例子，当初始值为-0.8，学习率为1时，迭代的情况很尴尬：不断在一条水平线上跳来跳去，永远也不能下降。
<img src=".\Images\2\gd100.png"> 
当学习率=0.8时，会有这种左右跳跃的情况发生，这不利于神经网络的训练。
<img src=".\Images\2\gd080.png"> 
当学习率=0.6时，也会有跳跃，幅度偏小。
<img src=".\Images\2\gd060.png"> 
当学习率=0.4时，损失值会从单侧下降，4步以后基本接近了理想值。
<img src=".\Images\2\gd040.png"> 
当学习率=0.2时，损失值会从单侧下降，但下降速度较慢，8步左右接近极值。
<img src=".\Images\2\gd020.png"> 
当学习率=0.1时，损失值会从单侧下降，但下降速度非常慢，10步了还没有到达理想状态。
<img src=".\Images\2\gd010.png"> 



