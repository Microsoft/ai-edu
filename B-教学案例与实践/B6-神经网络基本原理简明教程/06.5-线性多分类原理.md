Copyright © Microsoft Corporation. All rights reserved.
  适用于[License](https://github.com/Microsoft/ai-edu/blob/master/LICENSE.md)版权许可

# 线性多分类原理

此原理对线性和非线性多分类都适用。

## 分类函数 - Softmax

$$
a_j = \frac{e^{z_j}}{\sum\limits_{i=1}^m e^{z_i}}=\frac{e^{z_j}}{e^{z_1}+e^{z_2}+\dots+e^{z_m}}
$$

## 正向计算

### 神经网络计算

如果是多层的话，只考虑最后一层的计算：

$$
z_j = wx_j+b  \tag{1}
$$

### 分类计算

$$
a_j = \frac{e^{z_j}}{\sum\limits_{i=1}^m e^{z_i}}=\frac{e^{z_j}}{e^{z_1}+e^{z_2}+\dots+e^{z_m}} \tag{2}
$$

### 损失函数计算

$$J(w,b) =- \sum_{i=1}^m \sum_{j=1}^n y_{ij} \log a_{ij} \tag{3}$$

m是样本数，n是类别数。在交叉熵函数一节有详细介绍。

## 结合损失函数的整体反向传播公式

$$\frac{\partial{J}}{\partial{z_j}} = a_j-y_j \tag{4}$$

## 神经网络的线性多分类工作原理

木头：前面的二分类好像很容易理解哦！一条直线分开两个部分就行辣！多分类问题，貌似有很多种分法啊，如何下手呢？

<img src=".\Images\6\MultipleClassifierData.png">

【图6.5.1 原始数据分布图】

铁柱：我们从上面的公式入手，来看看神经网络如何工作的吧！

### 假设第一类的概率最大

假设一共有三类，红色为1，绿色为2，蓝色为3，那么Softmax的形式应该是：

$$
a_j = \frac{e^{z_j}}{\sum\limits_{i=1}^3 e^{z_i}}=\frac{e^{z_j}}{e^{z_1}+e^{z_2}+^{z_3}}
$$

如果判定一个点属于第一类，则有：

$$a_1 > a2 , 且: a_1 > a_3 \tag{5}$$

由于Softmax的特殊形式，分母都一样，所以只比较分子就行了。而分子是一个自然指数，输出值域大于零且单调递增，所以只比较指数就可以了，因此，公式5等同于下式：

$$z_1 > z_2 , 且: z_1 > z_3 \tag{6}$$

把z的公式引入：

$$z_1 = w_{11} \cdot x_1 + w_{12} \cdot x_2 + b1 \tag{7}$$
$$z_2 = w_{21} \cdot x_1 + w_{22} \cdot x_2 + b2 \tag{8}$$
$$z_3 = w_{31} \cdot x_1 + w_{32} \cdot x_2 + b3 \tag{9}$$

如果满足公式6，则：

$$w_{11} \cdot x_1 + w_{12} \cdot x_2 + b1  > w_{21} \cdot x_1 + w_{22} \cdot x_2 + b2 \tag{10}$$
$$w_{11} \cdot x_1 + w_{12} \cdot x_2 + b1  > w_{31} \cdot x_1 + w_{32} \cdot x_2 + b3 \tag{11}$$

变形金刚：

$$(w_{12} - w_{22})x_2 > (w_{21} - w_{11})x_1 + (b2 - b1) \tag{12}$$

$$(w_{12} - w_{32})x_2 > (w_{31} - w_{11})x_1 + (b3 - b1) \tag{13}$$

我们先假设：

$$w_{12} > w_{22} > w_{32} \tag{14}$$

所以公式12，13左侧的系数都大于零，两边同时除以系数：

$$x_2 > {w_{21} - w_{11} \over w_{12} - w_{22}}x_1 + {b2 - b1 \over w_{12} - w_{22}} \tag{15}$$

$$x_2 > {w_{31} - w_{11} \over w_{12} - w_{32}} x_1 + {b3 - b1 \over w_{12} - w_{32}} \tag{16}$$

简化：

$$y > W_1 \cdot x + B_1 \tag{17}$$

$$y > W_2 \cdot x + B_2 \tag{18}$$

也就是说在图中画两条直线，所有红点都同时在蓝线1和绿线2这两条直线的上方，如下图所示：

<img src=".\Images\6\z1z2z3.png">

【图6.5.2 红1类分割图】

### 假设第二类的概率最大

同理，如果：

$$z_2 > z_1 , 且: z_2 > z_3$$

则：

$$w_{21} \cdot x_1 + w_{22} \cdot x_2 + b2 > w_{11} \cdot x_1 + w_{12} \cdot x_2 + b1$$
$$w_{21} \cdot x_1 + w_{22} \cdot x_2 + b2  > w_{31} \cdot x_1 + w_{32} \cdot x_2 + b3$$

使用与公式14相同的假设，变形后成为：

$$x_2 < {w_{11} - w_{21} \over w_{22} - w_{12}}x_1 + {b1 - b2 \over w_{22} - w_{12}} \tag{19}$$

$$x_2 > {w_{31} - w_{21} \over w_{22} - w_{32}} x_1 + {b3 - b2 \over w_{22} - w_{32}} \tag{20}$$

由于：

$${w_{11} - w_{21} \over w_{22} - w_{12}} = {w_{21} - w_{11} \over w_{12} - w_{22}}$$

所以：

$$y < W_1 \cdot x + B_1 \tag{21}$$

$$y > W_3 \cdot x + B_3 \tag{22}$$

注意公式19，因为根据假设，$w_{22} < w_{12}$，所以两边同时除以它时，不等号要改变方向。

如果画出直线来，是这个样子，即所有绿点都在红线3的上方，在蓝线1的下方：

<img src=".\Images\6\z2z1z3.png">

【图6.5.3 绿2类分割图】

### 假设第三类的概率最大

$$z_3 > z_1 , 且: z_3 > z_3$$

$$w_{31} \cdot x_1 + w_{32} \cdot x_2 + b3 > w_{11} \cdot x_1 + w_{12} \cdot x_2 + b1$$
$$w_{31} \cdot x_1 + w_{32} \cdot x_2 + b3  > w_{21} \cdot x_1 + w_{22} \cdot x_2 + b2$$


$$x_2 < {w_{11} - w_{31} \over w_{32} - w_{12}}x_1 + {b1 - b3 \over w_{32} - w_{12}} \tag{23}$$

$$x_2 < {w_{21} - w_{31} \over w_{32} - w_{22}} x_1 + {b2 - b3 \over w_{32} - w_{22}} \tag{24}$$


$$y < W_2 \cdot x + B_2 \tag{25}$$

$$y < W_3 \cdot x + B_3 \tag{26}$$

注意，因为根据假设，$w_{32} < w_{22} < w_{12}$，所以两边同时除以它时，不等号要改变方向。图示如下，蓝点在红线3和绿线2的下方：

<img src=".\Images\6\z3z2z1.png">

【图6.5.4 蓝3类分割图】

把三张图综合在一起，应该是这个样子：

<img src=".\Images\6\z123.png">

【图6.5.5 三分类图】

木头：我们假设$w_{32} < w_{22} < w_{12}$是否有根据呢？

铁柱：我们在这个假设条件下，得到了上面这张图，如果换一个假设条件如$w_{32} > w_{22} > w_{12}$，三根线的大致位置还是这样，只不过斜率会有些变化。比如上图中的红线，现在是下方向左斜，换了条件后，有可能变成下方向右斜，整体的大于小于关系不会发生混乱。有兴趣的话可以自己推导一下。

