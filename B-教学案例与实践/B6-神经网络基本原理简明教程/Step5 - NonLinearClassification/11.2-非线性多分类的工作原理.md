Copyright © Microsoft Corporation. All rights reserved.
  适用于[License](https://github.com/Microsoft/ai-edu/blob/master/LICENSE.md)版权许可

## 11.2 非线性多分类的工作原理

### 11.2.1 隐层神经元数量的影响

下面列出了隐层神经元为2、4、8、16、32、64的情况，每个配置测试一轮。

|神经元数|损失函数|分类结果|
|---|---|---|
|2|<img src='../Images/11/loss_n2.png'/>|<img src='../Images/11/result_n2.png'/>|
||迭代10000轮，测试准确度0.608||
|4|<img src='../Images/11/loss_n4.png'/>|<img src='../Images/11/result_n4.png'/>|
||迭代6300轮，测试准确度0.966||
|8|<img src='../Images/11/loss_n8.png'/>|<img src='../Images/11/result_n8.png'/>|
||迭代5400轮，测试准确度0.964||
|16|<img src='../Images/11/loss_n16.png'/>|<img src='../Images/11/result_n16.png'/>|
||迭代3900轮，测试准确度0.964||
|32|<img src='../Images/11/loss_n32.png'/>|<img src='../Images/11/result_n32.png'/>|
||迭代5400轮，测试准确度0.97||
|64|<img src='../Images/11/loss_n64.png'/>|<img src='../Images/11/result_n64.png'/>|
||迭代2000轮，测试准确度0.958||




所以，隐层必须用3个神经元以上。但是，由于使用了3个神经元，使得隐层的输出结果为每个样本一行三列。如果是一行两列的话，我们可以把两列数据看作横纵坐标，使用10.6节学习的知识，在二维平面上绘制中间结果；而一行三列的话，我们必须在三维空间中绘制中间结果。

#### 3D样本点分布图

```Python
def Show3D(net, dr):
    X,Y = dr.GetTestSet()
    net.inference(X)

    colors = ['b', 'r', 'g']
    shapes = ['s', 'x', 'o']

    fig = plt.figure(figsize=(6,6))
    ax = Axes3D(fig)
    count = Y.shape[0]
    for i in range(count):
        for j in range(Y.shape[1]):
            if Y[i,j] == 1:
                ax.scatter(net.Z1[i,0],net.Z1[i,1],net.Z1[i,2], color=colors[j], marker=shapes[j])
    plt.show()

    fig = plt.figure(figsize=(6,6))
    ax = Axes3D(fig)
    count = Y.shape[0]
    for i in range(count):
        for j in range(Y.shape[1]):
            if Y[i,j] == 1:
                ax.scatter(net.A1[i,0],net.A1[i,1],net.A1[i,2], color=colors[j], marker=shapes[j])
    plt.show()
```

上述代码首先使用测试集（500个样本点）在已经训练好的网络上做一次推理，得到了隐层的计算结果，然后分别用net.Z1和net.A1的三列数据，绘制三维点图。

||正视角|侧视角|
|---|---|---|
|z1|<img src='../Images/11/bank_z1_1.png'/>|<img src='../Images/11/bank_z1_2.png'/>|
|a1|<img src='../Images/11/bank_a1_1.png'/>|<img src='../Images/11/bank_a1_2.png'/>|

net.Z1的点图的含义是，输入数据经过线性变换后的结果，可以看到由于只是线性变换，所以从侧视角看还只是一个二维平面的样子。

net.A1的点图含义是，经过激活函数做非线性变换后的图。由于绿色点比较靠近边缘，所以三维坐标中的每个值在经过Sigmoid激活函数计算后，都有至少一维坐标会是向1靠近的值，所以分散的比较开，形成外围的三角区域；蓝色点正好相反，三维坐标值都趋近于0，所以最后都集中在三维坐标原点的三角区域内；红色点处于前两者之间，因为有很多中间值。

再观察net.A1的侧视图，似乎是已经分层了，蓝点沉积下去，绿点浮上来，红点在中间，像鸡尾酒一样分成了三层，这就给第二层神经网络创造了做一个线性三分类的条件，只需要两个平面，就可以把三者轻松分开了。

#### 3D分类结果图

我们延续9.2节的3D效果体验，但是，多分类的实际实现方式是1对多的，所以我们只能一次显示一个类别的分类效果图。

|类别|斜侧图|投影图|
|---|---|---|
|类别1|<img src='../Images/11/multiple_3d_c1_1.png'/>|<img src='../Images/11/multiple_3d_c1_2.png'/>|
||红色为类别1样本区域|紫色为类别2、3样本区域|
|类别2|<img src='../Images/11/multiple_3d_c2_1.png'/>|<img src='../Images/11/multiple_3d_c2_2.png'/>|
||红色为类别2样本区域|紫色为类别1、3样本区域|
|类别2|<img src='../Images/11/multiple_3d_c3_1.png'/>|<img src='../Images/11/multiple_3d_c3_2.png'/>|
||红色为类别3样本区域|紫色为类别1、2样本区域|
|所有类别|<img src='../Images/11/multiple_3d_c1_c2_1.png'/>|<img src='../Images/11/multiple_3d_c1_c2_2.png'/>|
||红色是类别1，青色是类别2|紫色是类别3区域|

上表中最后一行的图片显示类别1和2的累加效果。由于最后的结果都被Softmax归一为[0,1]之间，所以我们可以简单地把类别1的数据乘以2，再加上类别2的数据即可。

### 代码位置

ch11, Level2
